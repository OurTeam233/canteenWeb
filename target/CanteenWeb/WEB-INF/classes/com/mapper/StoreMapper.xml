<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--命名空间为全类名-->
<mapper namespace="com.mapper.StoreMapper">
    <resultMap id="StoreResultMap" type="Store">
        <id column="id" property="id"/>
        <result column="store_name" property="name"/>
        <result column="address" property="address"/>
        <result column="phone" property="phone"/>
        <result column="score" property="score"/>
        <result column="logoUrl" property="logoUrl"/>
        <result column="attention" property="attention"/>
        <result column="sales" property="sales"/>
        <result column="description" property="description"/>
        <result column="status" property="status"/>
        <result column="per" property="per"/>
        <!--     将多个字段封装成一个对象 property为store的属性 JavaType为要封装成的实体类   -->
        <association property="canteen" javaType="Canteen">
            <id column="canteen_id" property="id"/>
            <result column="canteen_name" property="name"/>
        </association>
        <!--    封装成集合 property为store的属性 ofType为List集合中的泛型    -->
        <collection property="tags" ofType="Tags">
            <id column="tags_id" property="id"/>
            <result column="tags_name" property="name"/>
        </collection>
    </resultMap>

    <insert id="insertStore" parameterType="store" useGeneratedKeys="true" keyProperty="id">
        insert into store(name, address, phone, score, logoUrl, attention, sales, description, status, canteen_id,
                          canteen_name)
        values (#{name}, #{address}, #{phone}, 0, #{logoUrl}, 0, 0, #{description}, 0,
                #{canteen.id}, #{canteen.name})
    </insert>

    <delete id="deleteById">
        delete
        from store
        where id = #{id}
    </delete>

    <select id="selectStore" resultMap="StoreResultMap">
        SELECT s.id,
               s.`name` store_name,
               s.canteen_id,
               s.canteen_name,
               s.address,
               s.phone,
               s.score,
               s.logoUrl,
               s.attention,
               s.sales,
               s.description,
               s.status,
               s.per,
               st.tags_id,
               t.`name` tags_name
        FROM store s
                 LEFT JOIN storetags st ON st.store_id = s.id
                 LEFT JOIN tags t ON st.tags_id = t.id
    </select>

    <select id="selectStoreByCanteenId" resultMap="StoreResultMap">
        SELECT s.id,
               s.`name` store_name,
               s.canteen_id,
               s.canteen_name,
               s.address,
               s.phone,
               s.score,
               s.logoUrl,
               s.attention,
               s.sales,
               s.description,
               s.status,
               s.per,
               st.tags_id,
               t.`name` tags_name
        FROM store s
                 LEFT JOIN storetags st ON st.store_id = s.id
                 LEFT JOIN tags t ON st.tags_id = t.id
        WHERE s.canteen_id = #{canteenId}
    </select>

    <select id="selectStoreByTagsId" resultMap="StoreResultMap">
        SELECT s.id,
               s.`name` store_name,
               s.canteen_id,
               s.canteen_name,
               s.address,
               s.phone,
               s.score,
               s.logoUrl,
               s.attention,
               s.sales,
               s.description,
               s.status,
               s.per,
               st.tags_id,
               t.`name` tags_name
        FROM store s
                 LEFT JOIN storetags st ON st.store_id = s.id
                 LEFT JOIN tags t ON st.tags_id = t.id
        WHERE s.id in (
            SELECT store_id
            FROM storetags
            WHERE tags_id = #{tagsId}
        )
    </select>

    <select id="selectByStoreId" resultMap="StoreResultMap">
        SELECT s.id,
               s.`name` store_name,
               s.canteen_id,
               s.canteen_name,
               s.address,
               s.phone,
               s.score,
               s.logoUrl,
               s.attention,
               s.sales,
               s.description,
               s.status,
               s.per,
               st.tags_id,
               t.`name` tags_name
        FROM store s
                 LEFT JOIN storetags st ON st.store_id = s.id
                 LEFT JOIN tags t ON st.tags_id = t.id
        WHERE s.id = #{id}
    </select>

    <select id="likeSelectStore" resultMap="StoreResultMap">
        <bind name="keyword" value="'%' + keyword + '%'"/>
        SELECT
        s.id,
        s.`name` store_name,
        s.canteen_id,
        s.canteen_name,
        s.address,
        s.phone,
        s.score,
        s.logoUrl,
        s.attention,
        s.sales,
        s.description,
        s.status,
        s.per,
        st.tags_id,
        t.`name` tags_name
        FROM
        store s
        LEFT JOIN storetags st ON st.store_id = s.id
        LEFT JOIN tags t ON st.tags_id = t.id
        LEFT JOIN dishes d ON d.store_id = s.id
        WHERE d.`name` like #{keyword} OR s.`name` like #{keyword} OR t.name like #{keyword}
    </select>

    <select id="selectCollectionStore" resultMap="StoreResultMap">
        SELECT s.id,
               s.`name` store_name,
               s.canteen_id,
               s.canteen_name,
               s.address,
               s.phone,
               s.score,
               s.logoUrl,
               s.attention,
               s.sales,
               s.description,
               s.status,
               s.per,
               st.tags_id,
               t.`name` tags_name
        FROM store s
                 LEFT JOIN storetags st ON st.store_id = s.id
                 LEFT JOIN tags t ON st.tags_id = t.id
                 INNER JOIN collections c ON c.store_id = s.id
        WHERE c.student_id = #{studentId}
    </select>

    <update id="updateStoreStatus">
        UPDATE store
        SET status = #{status}
        WHERE id = #{storeId}
    </update>

    <select id="selectAvgPriceById" resultType="integer">
        SELECT AVG( totalPrice )
        FROM `order`
        WHERE store_id = #{storeId}
    </select>

    <update id="updatePerById">
        UPDATE store
        SET per = #{per}
        WHERE
            id = #{id}
    </update>
</mapper>