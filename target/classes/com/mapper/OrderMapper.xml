<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--命名空间为全类名-->
<mapper namespace="com.mapper.OrderMapper">
    <resultMap id="OrderResultMapper" type="order">
        <id column="orderId" property="id"/>
        <result column="studentId" property="studentId"/>
        <result column="orderNumber" property="orderNumber"/>
        <result column="orderTime" property="orderTime"/>
        <result column="time" property="time"/>
        <result column="note" property="note"/>
        <result column="totalPrice" property="totalPrice"/>
        <result column="canteen_name" property="canteenName"/>
        <result column="address" property="address"/>
        <result column="student_id" property="studentId"/>
        <result column="store_id" property="storeId"/>
        <collection property="orderDetailsList" ofType="orderDetails">
            <id column="dishesId" property="dishesId"/>
            <result column="name" property="name"/>
            <result column="price" property="price"/>
            <result column="num" property="num"/>
        </collection>
    </resultMap>

    <select id="selectOrderByStudentId" resultMap="OrderResultMapper">
        SELECT o.id orderId,
               o.orderNumber,
               o.orderTime,
               o.time,
               o.type,
               o.note,
               o.totalPrice,
               d.id dishesId,
               d.`name`,
               d.price,
               od.num,
               s.canteen_name,
               s.address
        FROM `order` o
                 LEFT JOIN orderdetails od ON od.order_id = o.id
                 LEFT JOIN dishes d ON d.id = od.dishes_id
                 LEFT JOIN store s ON s.id = o.store_id
        WHERE student_id = #{studentId}
    </select>

    <select id="selectOrderByStoreId" resultMap="OrderResultMapper">
        SELECT o.id orderId,
               o.orderNumber,
               o.orderTime,
               o.time,
               o.type,
               o.note,
               o.totalPrice,
               o.student_id,
               d.id dishesId,
               d.`name`,
               d.price,
               od.num
        FROM `order` o
                 LEFT JOIN orderdetails od ON od.order_id = o.id
                 LEFT JOIN dishes d ON d.id = od.dishes_id
                 LEFT JOIN store s ON s.id = o.store_id
        WHERE d.store_id = #{storeId}
    </select>


    <select id="selectOrderCount" resultType="int">
        SELECT count(*) sum
        FROM `order`
        WHERE `time` > #{time}
          AND store_id = #{storeId}
    </select>

    <insert id="insertOrder" parameterType="order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (student_id, store_id, orderNumber, orderTime, time, type, note, totalPrice)
        VALUES (#{order.studentId}, #{order.storeId}, #{order.orderNumber}, #{order.orderTime}, #{order.time},
                0,
                #{order.note}, #{order.totalPrice})
    </insert>

    <insert id="insertOrderDetails" parameterType="orderDetails" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO orderdetails (order_id, dishes_id, num)
        VALUES (#{orderDetails.orderId}, #{orderDetails.dishesId}, #{orderDetails.num})
    </insert>
</mapper>